{"version":3,"sources":["../../../src/db/leagueApi.js"],"names":["conn","require","season","userApi","moment","isNil","isString","ObjectId","updateLeague","league","db","coll","collection","leagueId","_id","findOneAndUpdate","getSeason","console","log","legaueId","getLeaguesForUser","userId","find","teams","$elemMatch","user","fields","draft","toArray","leagues","getLeagueInvitations","getUserById","invitations","email","name","commissioner","acceptInvitation","teamName","findOne","newInvitations","filter","invite","push","draftList","currentRoster","$set","declineInvitation","id","getLeague","createLeague","state","settings","rounds","insertOne","unregisteredUsers","forEach","trim","registerUser","saveLeague","getAvailablePlayers","aggregate","megaMatch","signedPlayers","team","player","filteredList","players","index","findIndex","sp","key","module","exports"],"mappings":"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","file":"leagueApi.js","sourcesContent":["const conn = require('./connection');\nconst season = require('../utils/season');\nconst userApi = require('./userApi');\nconst moment = require('moment');\nconst isNil = require('lodash/isNil');\nconst isString = require('lodash/isNil');\nconst ObjectId = require('mongodb').ObjectId;\n\nconst updateLeague = async (league) => {\n  const db = await conn.db;\n  const coll = db.collection('leagues');\n\n  const leagueId = isString(league) ?\n    league : league._id;\n\n  try {\n    await coll.findOneAndUpdate({\n      '_id': ObjectId(leagueId),\n      'season': season.getSeason(moment())\n    },\n    league);\n  }\n  catch(err) {\n    console.log(`Error saving league ${legaueId}`);\n  }\n};\n\nconst getLeaguesForUser = async (userId) => {\n  const db = await conn.db;\n  const coll = db.collection('leagues');\n\n  try {\n    const leagues = await coll.find({ teams:\n      {\n        $elemMatch: {\n          user: userId\n        }\n      }\n    }, {\n      fields: {draft: 0}\n    }).toArray();\n\n    return leagues;\n  }\n  catch(err) {\n    console.log(`Error saving league: ${err}`);\n  }\n};\n\nconst getLeagueInvitations = async (userId) => {\n  const db = await conn.db;\n  const coll = db.collection('leagues');\n\n  try {\n    const user = await userApi.getUserById(userId);\n    const leagues = await coll.find({ invitations:\n      {\n        $elemMatch: {\n          email: user.email\n        }\n      }\n    }, {\n      fields: {name: 1, commissioner: 1, _id: 1}\n    }).toArray();\n\n    return leagues;\n  }\n  catch(err) {\n    console.log(`Error saving league: ${err}`);\n  }\n};\n\nconst acceptInvitation = async (userId, leagueId, teamName) => {\n  const db = await conn.db;\n  const coll = db.collection('leagues');\n\n  const invitations = await coll.findOne({\n    '_id': ObjectId(leagueId)\n  }, {\n    fields: {invitations: 1, teams: 1}\n  });\n\n  const user = await userApi.getUserById(userId);\n\n  const newInvitations = invitations.invitations.filter( (invite) => {\n    return invite.email !== user.email;\n  });\n\n  invitations.teams.push({\n    name: teamName,\n    user: userId,\n    draftList: [],\n    currentRoster: []\n  });\n\n  await coll.findOneAndUpdate({\n    '_id': ObjectId(leagueId)\n  }, {\n    $set: {\n      invitations: newInvitations,\n      teams: invitations.teams\n    }\n  });\n};\n\nconst declineInvitation = async (userId, leagueId) => {\n  const db = await conn.db;\n  const coll = db.collection('leagues');\n\n  const invitations = await coll.findOne({\n    '_id': ObjectId(leagueId)\n  }, {\n    fields: {invitations: 1}\n  });\n\n  const newInvitations = invitations.invitations.filter( (invite) => {\n    return invite.id !== userId;\n  });\n\n  await coll.findOneAndUpdate({\n    '_id': ObjectId(leagueId)\n  }, {\n    $set: {\n      invitations: newInvitations\n    }\n  });\n};\n\nconst getLeague = async( leagueId ) => {\n  const db = await conn.db;\n  const coll = db.collection('leagues');\n\n  const league = await coll.findOne({\n    '_id': ObjectId(leagueId),\n    'season': season.getSeason(moment())\n  });\n\n  return league;\n};\n\nconst createLeague = async (league) => {\n  const db = await conn.db;\n  const coll = db.collection('leagues');\n\n  try {\n    league.season = season.getSeason(moment());\n    league.draft = {\n      state: 'PREDRAFT',\n      settings: {},\n      rounds: []\n    };\n\n    await coll.insertOne({ ...league });\n\n    // now create users that aren't registered\n    const unregisteredUsers = league.invitations.filter( (invite) => {\n      return isNil(invite.id);\n    });\n\n    unregisteredUsers.forEach( (user) => {\n      user.email = user.email.trim();\n      userApi.registerUser(user, false);\n    });\n  }\n  catch(err) {\n    console.log(`Error saving league: ${err}`);\n  }\n};\n\nconst saveLeague = async(league) => {\n  if (!isNil(league._id)) {\n    return updateLeague(league)\n  }\n\n  return createLeague(league);\n}\n\nconst getAvailablePlayers = async (leagueId) => {\n  const db = await conn.db;\n  const coll = db.collection('leagues');\n\n  try {\n    const megaMatch = await coll.aggregate([\n      { \"$match\": {\"_id\": ObjectId(leagueId)}},\n      { \"$lookup\":\n        {\n          \"from\": \"players\",\n          \"localField\":\n          \"season\",\n          \"foreignField\": \"year\",\n          \"as\": \"players\"\n        }\n      }]).toArray();\n\n    const league = await getLeague(leagueId);\n    const signedPlayers = [];\n\n    league.teams.forEach( (team) => {\n      if (isNil(team.currentRoster)) {\n        return;\n      }\n\n      team.currentRoster.forEach( (player) => {\n        signedPlayers.push(player);\n      });\n    })\n\n    const filteredList = megaMatch[0].players[0].players.filter( (player) => {\n      const index = signedPlayers.findIndex( (sp) => {\n        return sp.key === player.key;\n      });\n\n      return index === -1;\n    });\n\n    return filteredList;\n  }\n  catch(err) {\n    console.log(`Error getting player list ${err}`);\n  }\n\n  return [];\n};\n\nmodule.exports = {\n  saveLeague,\n  getLeaguesForUser,\n  getAvailablePlayers,\n  getLeague,\n  getLeagueInvitations,\n  acceptInvitation,\n  declineInvitation\n};\n"]}