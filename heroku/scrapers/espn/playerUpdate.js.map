{"version":3,"sources":["../../../server/src/scrapers/espn/playerUpdate.js"],"names":["cheerio","require","fs","path","request","asyncRequest","moment","isNil","season","resultsApi","EspnPlayerUpdater","year","getSeason","lastPlayerUpdate","lastUpdated","diff","htmlFile","undefined","shouldIUpdate","shouldUpdate","getRoster","savedRoster","length","downloadPlayerList","readFileSync","html","roster","parseHtml","saveRoster","$","row","tds","name","text","split","origin","firstName","lastName","key","toLowerCase","load","oddrows","evenrows","oddPlayers","map","index","parsePlayer","get","evenPlayers","players","concat","module","exports"],"mappings":";;;;;;;;;;;;;;;;;;;;AAAA,IAAMA,UAAUC,QAAQ,SAAR,CAAhB;AACA,IAAMC,KAAKD,QAAQ,IAAR,CAAX;AACA,IAAME,OAAOF,QAAQ,MAAR,CAAb;AACA,IAAMG,UAAUH,QAAQ,SAAR,CAAhB;AACA,IAAMI,eAAeJ,QAAQ,iBAAR,CAArB;AACA,IAAMK,SAASL,QAAQ,QAAR,CAAf;AACA,IAAMM,QAAQN,QAAQ,cAAR,CAAd;;AAGA,IAAMO,SAASP,QAAQ,oBAAR,CAAf;AACA,IAAMQ,aAAaR,QAAQ,qBAAR,CAAnB;;IAEMS,iB;;;;;;;;;;;;;;AAGIC,oB,GAAOH,OAAOI,SAAP,CAAiBN,QAAjB,C;;uBACaG,WAAWI,gBAAX,CAA4BF,IAA5B,C;;;AAApBG,2B;iDACCR,SAASS,IAAT,CAAcD,WAAd,EAA2B,OAA3B,IAAsC,E;;;;;;;;;;;;;;;;;;;;YAG3BE,Q,uEAAWC,S;;;;;;;uBACF,KAAKC,aAAL,E;;;AAArBC,4B;;sBAEFA,iBAAiB,K;;;;;;;;AAIfR,oB,GAAOH,OAAOI,SAAP,CAAiBN,QAAjB,C;;uBAEaG,WAAWW,SAAX,CAAqBT,IAArB,C;;;AAApBU,2B;;sBAEF,CAACd,MAAMc,WAAN,CAAD,IAAuBA,YAAYC,MAAZ,GAAqB,C;;;;;;;;qBAInCf,MAAMS,QAAN,C;;;;;;uBACL,KAAKO,kBAAL,E;;;;;;;;;uBACArB,GAAGsB,YAAH,CAAgBR,QAAhB,C;;;;;;AAFFS,oB;AAIAC,sB,GAAS,KAAKC,SAAL,CAAeF,IAAf,C;;AACfC,uBAAOf,IAAP,GAAcA,IAAd;;AAEAF,2BAAWmB,UAAX,CAAsBjB,IAAtB,EAA4Be,MAA5B;;kDAEOA,M;;;;;;;;;;;;;;;;;;;;;;;;;uBAIMrB,aAAa,kCAAb,C;;;;;;;;;;;;;;;;;;;;;gCAGHwB,C,EAAGC,G,EAAK;AAClB,UAAMC,MAAMF,EAAE,IAAF,EAAQ,EAAR,EAAYC,GAAZ,CAAZ;AACA,UAAME,OAAOH,EAAE,GAAF,EAAO,EAAP,EAAWE,IAAI,CAAJ,CAAX,EAAmBE,IAAnB,GAA0BC,KAA1B,CAAgC,IAAhC,CAAb;AACA,UAAMC,SAASN,EAAEE,IAAI,CAAJ,CAAF,EAAUE,IAAV,EAAf;;AAEA,UAAMG,YAAYJ,KAAK,CAAL,CAAlB;AACA,UAAMK,WAAWL,KAAK,CAAL,CAAjB;AACA,UAAMM,MAASF,UAAUG,WAAV,EAAT,SAAoCF,SAASE,WAAT,EAA1C;;AAEA,aAAO;AACLD,gBADK;AAELF,4BAFK;AAGLC;AAHK,OAAP;AAKD;;;8BAESZ,I,EAAM;AAAA;;AACd,UAAMI,IAAI7B,QAAQwC,IAAR,CAAaf,IAAb,CAAV;;AAEA,UAAMgB,UAAUZ,EAAE,WAAF,CAAhB;AACA,UAAMa,WAAWb,EAAE,YAAF,CAAjB;;AAEA,UAAMc,aAAaF,QAAQG,GAAR,CAAa,UAACC,KAAD,EAAQf,GAAR,EAAgB;AAC9C,eAAO,MAAKgB,WAAL,CAAiBjB,CAAjB,EAAoBC,GAApB,CAAP;AACD,OAFkB,EAEhBiB,GAFgB,EAAnB;AAGA,UAAMC,cAAcN,SAASE,GAAT,CAAc,UAACC,KAAD,EAAQf,GAAR,EAAgB;AAChD,eAAO,MAAKgB,WAAL,CAAiBjB,CAAjB,EAAoBC,GAApB,CAAP;AACD,OAFmB,EAEjBiB,GAFiB,EAApB;;AAIA,UAAME,UAAUN,WAAWO,MAAX,CAAkBF,WAAlB,CAAhB;;AAEA,aAAO;AACLC;AADK,OAAP;AAGD;;;;;AAGHE,OAAOC,OAAP,GAAiB;AACf1C;AADe,CAAjB","file":"playerUpdate.js","sourcesContent":["const cheerio = require('cheerio');\nconst fs = require('fs');\nconst path = require('path');\nconst request = require('request');\nconst asyncRequest = require('request-promise');\nconst moment = require('moment');\nconst isNil = require('lodash/isNil');\n\n\nconst season = require('../../utils/season');\nconst resultsApi = require('../../db/resultsApi');\n\nclass EspnPlayerUpdater {\n\n  async shouldIUpdate() {\n    const year = season.getSeason(moment());\n    const lastUpdated = await resultsApi.lastPlayerUpdate(year);\n    return moment().diff(lastUpdated, 'hours') > 23;\n  }\n\n  async updatePlayers(htmlFile = undefined) {\n    const shouldUpdate = await this.shouldIUpdate();\n\n    if (shouldUpdate === false) {\n      return;\n    }\n\n    const year = season.getSeason(moment());\n\n    const savedRoster = await resultsApi.getRoster(year);\n\n    if (!isNil(savedRoster) && savedRoster.length > 0){\n      return;\n    }\n\n    const html = isNil(htmlFile) ?\n      await this.downloadPlayerList() :\n      await fs.readFileSync(htmlFile);\n\n    const roster = this.parseHtml(html);\n    roster.year = year;\n\n    resultsApi.saveRoster(year, roster);\n\n    return roster;\n  }\n\n  async downloadPlayerList() {\n    return await asyncRequest('http://www.espn.com/golf/players');\n  }\n\n  parsePlayer($, row) {\n    const tds = $('td', '', row);\n    const name = $('a', '', tds[0]).text().split(', ');\n    const origin = $(tds[1]).text();\n\n    const firstName = name[1];\n    const lastName = name[0];\n    const key = `${firstName.toLowerCase()}+${lastName.toLowerCase()}`;\n\n    return {\n      key,\n      firstName,\n      lastName\n    };\n  }\n\n  parseHtml(html) {\n    const $ = cheerio.load(html);\n\n    const oddrows = $('tr.oddrow');\n    const evenrows = $('tr.evenrow');\n\n    const oddPlayers = oddrows.map( (index, row) => {\n      return this.parsePlayer($, row);\n    }).get();\n    const evenPlayers = evenrows.map( (index, row) => {\n      return this.parsePlayer($, row);\n    }).get();\n\n    const players = oddPlayers.concat(evenPlayers);\n\n    return {\n      players\n    };\n  }\n}\n\nmodule.exports = {\n  EspnPlayerUpdater\n};\n"]}